<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Beta</title>
    <style>
      * {
        font-family: hack, monospace;
      }
      form {
        display: flex;
        flex-flow: row wrap;
        align-items: center;
      }
      nav {
        width: 100%;
        display: inline-flex;
        flex-flow: row wrap;
        align-items: center;
        justify-content: space-between;
      }
      body {
        width: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="/resources/app/connections.js"></script>
    <script>
      function createMessage(username, msg) {
        let obj = document.createElement("p");
        obj.classList.add("message");
        let name = document.createElement("b");
        name.classList.add("username");
        name.textContent = username;
        obj.appendChild(name);
        obj.appendChild(document.createTextNode(`: ${msg}`));
        return obj;
      }
      function loads(event) {
        event.preventDefault();
        let url = event.target.url.value;
        ModifConn(url);
      }
      function setupSocket(ws) {
        let cont = document.getElementById("msg-container");
        ws.addEventListener("message", (event) => {
          let json = JSON.parse(event.data);
          let msg = createMessage(json.username, json.msg);
          cont.appendChild(msg);
          if (cont.childElementCount > 50) {
            cont.removeChild(cont.children[0]);
          }
        });
      }
      function sendmsg(event) {
        event.preventDefault();
        let name = event.target.username.value;
        let msg = event.target.msg.value;
      }
      window.onload = () => {
        document.addEventListener("ConnModify", () => {
          let name = document.getElementById("server-name");
          let img = document.getElementById("server-img");
          let descript = document.getElementById("server-descript");
          name.textContent = ConnControl.name;
          img.src = `${ConnControl.host}/pfp.png`;
          descript.textContent = ConnControl.description;
          setupSocket(ConnControl.socketobj);
        });
      };
    </script>
  </head>
  <body>
    <nav>
      <h1>Zipper-Chat backend beta test</h1>
      <form onsubmit="loads(event)">
        <h2>Load server</h2>
        <input
          pattern="(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]"
          required
          name="url"
        />
        <input type="submit" value="Join!" />
      </form>
    </nav>
    <h3 id="server-name">Server name</h3>
    <img id="server-img" width="100" height="100" />
    <p id="server-descript">Server Description</p>
    <div
      display="max-height: 60vh; overflow-y: scroll;"
      id="msg-container"
    ></div>
    <form onsubmit="sendmsg(event)">
      <input name="username" required placeholder="Username" />
      <input
        name="msg"
        required
        style="width: 500px"
        placeholder="Message here"
      />
      <input type="submit" value="chat" />
    </form>
  </body>
</html>
